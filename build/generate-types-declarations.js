const Components = require('./components.js')
const { existsSync } = require('fs')
const { writeFile, mkdir, copyFile, rmdir } = require('fs/promises')
const render = require('json-templater/string')
const path = require('path')

const COMPONENTS_DECLARATION_PATH = path.join(__dirname, './../types')
const INDEX_D_PATH = path.join(__dirname, './../index.d.ts')
const MODULE_DECLARATION_TEMPLATE = `
/* Automatically generated by './build/generate-types-declarations.js' */
declare module 'maz-ui/lib/{{component_name}}';
`

const ComponentsNameArray = Object.keys(Components)

const generateDeclarationComponents = async (outputPath, componentsArray) => {
  if (existsSync(outputPath)) await rmdir(outputPath, { recursive: true })
  await mkdir(outputPath)

  const outIndexPath = path.join(outputPath, 'index.d.ts')
  const mazUiIndexPath = path.join(outputPath, 'maz-ui.common.d.ts')

  await copyFile(INDEX_D_PATH, outIndexPath)
  await copyFile(INDEX_D_PATH, mazUiIndexPath)
  componentsArray.forEach(async (c) => {
    const template = render(MODULE_DECLARATION_TEMPLATE, {
      component_name: c
    })
    await writeFile(`${outputPath}/${c}.d.ts`, template)
  })
}

generateDeclarationComponents(COMPONENTS_DECLARATION_PATH, ComponentsNameArray)